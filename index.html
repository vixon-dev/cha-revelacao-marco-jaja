<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cha Revelacao - Marco Tulio e Jaja</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ffecd2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 650px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-family: 'Dancing Script', cursive;
      font-size: 2.8rem;
      color: #5a3d5c;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.1rem;
      color: #666;
      font-weight: 300;
    }

    .parents {
      font-size: 1.3rem;
      color: #e75480;
      font-weight: 600;
      margin-top: 5px;
    }

    .emoji-header {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      transition: border-color 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #e75480;
    }

    .escolha-container {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .escolha-btn {
      flex: 1;
      min-width: 100px;
      padding: 15px 10px;
      border: 3px solid #e0e0e0;
      border-radius: 15px;
      background: white;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .escolha-btn:hover {
      transform: scale(1.02);
    }

    .escolha-btn.menino {
      border-color: #87ceeb;
    }

    .escolha-btn.menino:hover,
    .escolha-btn.menino.selected {
      background: linear-gradient(135deg, #87ceeb, #4a90d9);
      color: white;
      border-color: #4a90d9;
    }

    .escolha-btn.menina {
      border-color: #ffb6c1;
    }

    .escolha-btn.menina:hover,
    .escolha-btn.menina.selected {
      background: linear-gradient(135deg, #ffb6c1, #e75480);
      color: white;
      border-color: #e75480;
    }

    .escolha-btn.gemeos {
      border-color: #dda0dd;
    }

    .escolha-btn.gemeos:hover,
    .escolha-btn.gemeos.selected {
      background: linear-gradient(135deg, #dda0dd, #9370db);
      color: white;
      border-color: #9370db;
    }

    .escolha-emoji {
      font-size: 2rem;
      display: block;
      margin-bottom: 5px;
    }

    .escolha-texto {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .btn-votar {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .btn-votar:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-votar:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .estatisticas {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .stat-item {
      text-align: center;
      padding: 12px;
      border-radius: 15px;
      min-width: 80px;
      flex: 1;
    }

    .stat-item.menino {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    }

    .stat-item.menina {
      background: linear-gradient(135deg, #fce4ec, #f8bbd9);
    }

    .stat-item.gemeos {
      background: linear-gradient(135deg, #f3e5f5, #e1bee7);
    }

    .stat-item.total {
      background: linear-gradient(135deg, #fff3e0, #ffe0b2);
    }

    .stat-numero {
      font-size: 1.8rem;
      font-weight: 600;
      color: #333;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #666;
    }

    .lista-votos h3 {
      margin-bottom: 15px;
      color: #5a3d5c;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .voto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 8px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .voto-item.menino {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-left: 4px solid #4a90d9;
    }

    .voto-item.menina {
      background: linear-gradient(135deg, #fce4ec, #f8bbd9);
      border-left: 4px solid #e75480;
    }

    .voto-item.gemeos {
      background: linear-gradient(135deg, #f3e5f5, #e1bee7);
      border-left: 4px solid #9370db;
    }

    .voto-nome {
      font-weight: 600;
      color: #333;
    }

    .voto-escolha {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }

    .mensagem {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      text-align: center;
      font-weight: 500;
      animation: fadeIn 0.3s ease;
    }

    .mensagem.sucesso {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .mensagem.erro {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .sem-votos {
      text-align: center;
      color: #999;
      padding: 20px;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      color: #888;
      font-size: 0.85rem;
    }

    .sync-status {
      text-align: center;
      font-size: 0.75rem;
      color: #999;
      margin-top: 10px;
    }

    .sync-status.online {
      color: #28a745;
    }

    .sync-status.offline {
      color: #dc3545;
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 2.2rem;
      }
      
      .escolha-container {
        flex-direction: column;
      }
      
      .escolha-emoji {
        font-size: 1.8rem;
      }

      .stat-item {
        min-width: 70px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="emoji-header">üë∂üçº</div>
      <h1>Cha Revelacao</h1>
      <p class="subtitle">Qual sera o sexo do bebe?</p>
      <p class="parents">Marco Tulio & Jaja</p>
    </header>

    <div class="card">
      <div id="mensagem"></div>
      
      <form id="formVoto">
        <div class="form-group">
          <label for="nome">Seu nome:</label>
          <input type="text" id="nome" placeholder="Digite seu nome" required maxlength="50">
        </div>

        <div class="form-group">
          <label>Sua aposta:</label>
          <div class="escolha-container">
            <button type="button" class="escolha-btn menino" data-escolha="menino">
              <span class="escolha-emoji">üë¶üíô</span>
              <span class="escolha-texto">Menino</span>
            </button>
            <button type="button" class="escolha-btn menina" data-escolha="menina">
              <span class="escolha-emoji">üëßüíñ</span>
              <span class="escolha-texto">Menina</span>
            </button>
            <button type="button" class="escolha-btn gemeos" data-escolha="gemeos">
              <span class="escolha-emoji">üë∂üë∂</span>
              <span class="escolha-texto">Gemeos</span>
            </button>
          </div>
        </div>

        <input type="hidden" id="escolha" value="">
        
        <button type="submit" class="btn-votar" id="btnVotar" disabled>
          Fazer minha aposta!
        </button>
      </form>
    </div>

    <div class="card">
      <div class="estatisticas">
        <div class="stat-item menino">
          <div class="stat-numero" id="countMenino">0</div>
          <div class="stat-label">üë¶ Menino</div>
        </div>
        <div class="stat-item menina">
          <div class="stat-numero" id="countMenina">0</div>
          <div class="stat-label">üëß Menina</div>
        </div>
        <div class="stat-item gemeos">
          <div class="stat-numero" id="countGemeos">0</div>
          <div class="stat-label">üë∂üë∂ Gemeos</div>
        </div>
        <div class="stat-item total">
          <div class="stat-numero" id="countTotal">0</div>
          <div class="stat-label">üìä Total</div>
        </div>
      </div>

      <div class="lista-votos">
        <h3>üìã Apostas realizadas</h3>
        <div id="listaVotos">
          <div class="loading">Carregando...</div>
        </div>
      </div>
      <div id="syncStatus" class="sync-status"></div>
    </div>

    <footer>
      Feito com üíú para o cha revelacao do Marco Tulio e Jaja
    </footer>
  </div>

  <script>
    // Configuracao JSONBin.io
    const JSONBIN_BIN_ID = '696c613ed0ea881f407369ca';
    const JSONBIN_API_KEY = '$2a$10$0TB7Nqo5wXgc5300J6icxOjNLqG8lrg7WzBe4BHifW/XdiN3KcRMu';
    const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

    const STORAGE_KEY = 'cha_revelacao_votos_v3';
    let escolhaSelecionada = '';
    let dadosAtuais = { votos: [] };
    let isOnline = false;

    // Funcoes localStorage (backup)
    function carregarDadosLocal() {
      try {
        const dados = localStorage.getItem(STORAGE_KEY);
        if (dados) return JSON.parse(dados);
      } catch (e) {}
      return { votos: [] };
    }

    function salvarDadosLocal(dados) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dados));
        return true;
      } catch (e) {
        return false;
      }
    }

    // Selecionar escolha
    document.querySelectorAll('.escolha-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.escolha-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        escolhaSelecionada = btn.dataset.escolha;
        document.getElementById('escolha').value = escolhaSelecionada;
        atualizarBotao();
      });
    });

    function atualizarBotao() {
      const nome = document.getElementById('nome').value.trim();
      document.getElementById('btnVotar').disabled = !nome || !escolhaSelecionada;
    }

    document.getElementById('nome').addEventListener('input', atualizarBotao);

    function mostrarMensagem(texto, tipo) {
      const div = document.getElementById('mensagem');
      div.innerHTML = `<div class="mensagem ${tipo}">${texto}</div>`;
      setTimeout(() => { div.innerHTML = ''; }, 5000);
    }

    function normalizarNome(nome) {
      return nome.toLowerCase().trim().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getEscolhaDisplay(escolha) {
      switch(escolha) {
        case 'menino': return 'üë¶üíô Menino';
        case 'menina': return 'üëßüíñ Menina';
        case 'gemeos': return 'üë∂üë∂ Gemeos';
        default: return escolha;
      }
    }

    function atualizarInterface(votos) {
      const lista = votos || [];
      
      const estatisticas = {
        total: lista.length,
        menino: lista.filter(v => v.escolha === 'menino').length,
        menina: lista.filter(v => v.escolha === 'menina').length,
        gemeos: lista.filter(v => v.escolha === 'gemeos').length
      };
      
      document.getElementById('countMenino').textContent = estatisticas.menino;
      document.getElementById('countMenina').textContent = estatisticas.menina;
      document.getElementById('countGemeos').textContent = estatisticas.gemeos;
      document.getElementById('countTotal').textContent = estatisticas.total;
      
      const listaEl = document.getElementById('listaVotos');
      if (lista.length === 0) {
        listaEl.innerHTML = '<div class="sem-votos">Nenhuma aposta ainda. Seja o primeiro!</div>';
      } else {
        const votosOrdenados = [...lista].sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
        listaEl.innerHTML = votosOrdenados.map(voto => `
          <div class="voto-item ${voto.escolha}">
            <span class="voto-nome">${escapeHtml(voto.nome)}</span>
            <span class="voto-escolha">${getEscolhaDisplay(voto.escolha)}</span>
          </div>
        `).join('');
      }
    }

    function atualizarSyncStatus(online) {
      isOnline = online;
      const el = document.getElementById('syncStatus');
      if (online) {
        el.textContent = 'üü¢ Sincronizado na nuvem';
        el.className = 'sync-status online';
      } else {
        el.textContent = 'üî¥ Modo offline (dados locais)';
        el.className = 'sync-status offline';
      }
    }

    // Carregar votos do JSONBin
    async function carregarVotos() {
      try {
        const response = await fetch(`${JSONBIN_URL}/latest`, {
          method: 'GET',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          dadosAtuais = data.record || { votos: [] };
          salvarDadosLocal(dadosAtuais);
          atualizarInterface(dadosAtuais.votos || []);
          atualizarSyncStatus(true);
        } else {
          throw new Error('Erro ao carregar');
        }
      } catch (e) {
        console.error('Erro ao carregar do JSONBin:', e);
        dadosAtuais = carregarDadosLocal();
        atualizarInterface(dadosAtuais.votos || []);
        atualizarSyncStatus(false);
      }
    }

    // Salvar votos no JSONBin
    async function salvarVotosRemoto(dados) {
      try {
        const response = await fetch(JSONBIN_URL, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_API_KEY
          },
          body: JSON.stringify(dados)
        });
        
        return response.ok;
      } catch (e) {
        console.error('Erro ao salvar no JSONBin:', e);
        return false;
      }
    }

    // Enviar voto
    document.getElementById('formVoto').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nome = document.getElementById('nome').value.trim();
      const escolha = escolhaSelecionada;
      
      if (!nome || !escolha) return;
      
      const btnVotar = document.getElementById('btnVotar');
      btnVotar.disabled = true;
      btnVotar.textContent = 'Enviando...';
      
      // Recarregar dados antes de verificar duplicado (para pegar votos mais recentes)
      await carregarVotos();
      
      const nomeNormalizado = normalizarNome(nome);
      
      // Verificar duplicado
      const votoDuplicado = (dadosAtuais.votos || []).find(v => normalizarNome(v.nome) === nomeNormalizado);
      if (votoDuplicado) {
        mostrarMensagem('Voce ja votou! Cada pessoa so pode votar uma vez.', 'erro');
        btnVotar.disabled = false;
        btnVotar.textContent = 'Fazer minha aposta!';
        atualizarBotao();
        return;
      }
      
      const novoVoto = {
        id: Date.now().toString(),
        nome: nome,
        escolha: escolha,
        dataHora: new Date().toISOString()
      };
      
      // Adicionar voto
      if (!dadosAtuais.votos) dadosAtuais.votos = [];
      dadosAtuais.votos.push(novoVoto);
      
      // Salvar localmente primeiro
      salvarDadosLocal(dadosAtuais);
      atualizarInterface(dadosAtuais.votos);
      
      // Tentar salvar remotamente
      const salvoRemoto = await salvarVotosRemoto(dadosAtuais);
      atualizarSyncStatus(salvoRemoto);
      
      if (salvoRemoto) {
        mostrarMensagem(`Aposta registrada! Voce apostou em ${getEscolhaDisplay(escolha)}`, 'sucesso');
      } else {
        mostrarMensagem(`Aposta salva localmente. Sincronizacao pendente.`, 'sucesso');
      }
      
      document.getElementById('nome').value = '';
      document.querySelectorAll('.escolha-btn').forEach(b => b.classList.remove('selected'));
      escolhaSelecionada = '';
      
      btnVotar.disabled = false;
      btnVotar.textContent = 'Fazer minha aposta!';
      atualizarBotao();
    });

    // Atualizar votos periodicamente (a cada 30 segundos)
    setInterval(carregarVotos, 30000);

    // Iniciar
    carregarVotos();
  </script>
</body>
</html>
